const express = require('express');
const bodyParser = require('body-parser');
const bcrypt = require('bcrypt');
const session = require('express-session');
const https = require('https');
const fs = require('fs');

const port = 3000;
const ip = '192.168.0.22';
const fixPassword = process.env.PASSWORD_HASH;

const options = {
    key: fs.readFileSync('privkey.pem'),
    cert: fs.readFileSync('cert.pem'),
    passphrase: 'phrase'
};

const app = express();
const server = https.createServer(options, app);

app.use(session({
    secret: 'mysecret',
    resave: false,
    saveUninitialized: true
}));

app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

app.get('/movement', requireLogin, (req, res) => {
    res.sendFile(__dirname + "/html/movement.html");
});

app.post('/movement', (req, res) => {
    if (req.session && req.session.loggedIn) {
        const command = req.body.command;
        console.log('Empfangener Befehl:', command);
        res.send('Command: ' + command);
    } else {
        res.redirect("/login");
    }
});

function requireLogin(req, res, next) {
    if (req.session && req.session.loggedIn) {
        return next();
    } else {
        res.redirect("/login");
    }
}

app.get('/login', (req, res) => {
    res.sendFile(__dirname + "/html/login.html");
});

function checkPassword(req, res, next) {
    const enteredPassword = req.body.password;
    if (!enteredPassword) {
        return res.status(400).send('Passwort fehlt');
    }
    bcrypt.compare(enteredPassword, fixPassword, (err, result) => {
        if (err || !result) {
            return res.status(401).send('Ungültiges Passwort!');
        } else {
            req.session.loggedIn = true;
            res.redirect("/movement");
        }
    });
}

app.post('/login', checkPassword);


server.on('error', (error) => {
    console.error('Fehler beim Starten des HTTPS-Servers:', error);
});
server.on('clientError', (error, socket) => {
    console.error('Fehler bei eingehender HTTPS-Verbindung:', error);
    socket.end('HTTP/1.1 400 Bad Request\r\n\r\n');
});


server.listen(port, ip, () => {
    console.log(`Server läuft auf https://${ip}:${port}/movement`);
});

